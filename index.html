<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCR Test Struk</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b1d2e; color:#fff; padding:20px; }
    h1 { text-align:center; color:#4facfe; }
    .card { background:#13283c; padding:20px; border-radius:10px; max-width:500px; margin:20px auto; }
    input, button { margin:10px 0; padding:10px; border-radius:6px; border:none; }
    button { background:#4facfe; color:#fff; font-weight:bold; cursor:pointer; }
    pre { background:#1b3550; padding:15px; border-radius:6px; white-space:pre-wrap; word-break:break-word; }
  </style>
</head>
<body>
  <h1>ğŸ” OCR Test Struk</h1>

  <div class="card">
    <label>Upload Struk:</label>
    <input type="file" id="strukFile" accept="image/*">
    <button onclick="checkStruk()">ğŸš€ Scan & Validasi</button>
    <p id="status"></p>
    <h3>ğŸ“œ Hasil OCR:</h3>
    <pre id="ocrResult"></pre>
  </div>

  <script>
    const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dn1eh1jfi/image/upload";
    const CLOUDINARY_PRESET = "Animal-cash-main";
    const VISION_API_KEY = "ISI_API_KEY_KAMU"; // <== GANTI dengan Vision API Key
    const ADMIN_ACCOUNT = "1234567890"; // <== Ganti dengan no rekening admin
    const EXPECTED_PRICE = 120000; // <== Ganti harga sesuai uji coba

    async function checkStruk() {
      const file = document.getElementById("strukFile").files[0];
      if (!file) return alert("Pilih struk dulu!");

      document.getElementById("status").innerText = "â³ Upload ke Cloudinary...";

      try {
        // === Upload ke Cloudinary ===
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_PRESET);

        const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
        const data = await res.json();
        if (!data.secure_url) throw new Error("Upload gagal ke Cloudinary!");

        document.getElementById("status").innerText = "â³ Scan OCR Google Vision...";

        // === OCR pakai Vision API ===
        const visionReq = {
          requests: [{
            image: { source: { imageUri: data.secure_url } },
            features: [{ type: "TEXT_DETECTION" }]
          }]
        };

        const visionRes = await fetch(
          `https://vision.googleapis.com/v1/images:annotate?key=${VISION_API_KEY}`,
          {
            method: "POST",
            body: JSON.stringify(visionReq),
            headers: { "Content-Type": "application/json" }
          }
        );

        const visionData = await visionRes.json();
        const text = visionData.responses?.[0]?.fullTextAnnotation?.text || "âŒ Tidak ada teks terbaca";
        document.getElementById("ocrResult").innerText = text;

        // === Validasi ===
        const expectedPriceStr = EXPECTED_PRICE.toLocaleString("id-ID").replace(/\./g, "");
        const regexPrice = new RegExp(expectedPriceStr, "g");

        let valid = true;

        if (!regexPrice.test(text)) {
          valid = false;
          alert("âŒ Struk tidak memuat nominal Rp " + EXPECTED_PRICE.toLocaleString("id-ID"));
        }

        if (!text.includes(ADMIN_ACCOUNT)) {
          valid = false;
          alert("âŒ Struk tidak memuat rekening tujuan admin (" + ADMIN_ACCOUNT + ")");
        }

        if (valid) {
          document.getElementById("status").innerText = "âœ… Struk valid!";
        } else {
          document.getElementById("status").innerText = "âš ï¸ Struk ditolak (tidak sesuai)";
        }

      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "âŒ Error: " + err.message;
      }
    }
  </script>
</body>
</html>
